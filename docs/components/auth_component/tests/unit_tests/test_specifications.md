# 認証コンポーネント単体テスト仕様

## 文書概要
**文書ID**: UT-AUTH-001  
**コンポーネント名**: 認証コンポーネント（AuthComponent）  
**作成日**: 2025-08-03  
**作成者**: 認証開発者  
**レビューア**: 品質保証エンジニア  
**バージョン**: 1.0  

## テスト戦略

### テスト目標
- **機能検証**: 各モジュールの機能要件達成確認
- **エラー処理**: 異常系・境界値での適切な動作確認
- **セキュリティ**: 暗号化・認証情報保護の確認
- **性能**: レスポンス時間・リソース使用量の確認

### テストカバレッジ目標
- **コードカバレッジ**: > 90%
- **ブランチカバレッジ**: > 85%
- **機能カバレッジ**: 100%（全API関数）
- **エラーパスカバレッジ**: 100%（全エラーケース）

## モジュール別テスト仕様

### 1. OAuth Manager テスト

#### 1.1 authenticate() テスト

##### TC-AUTH-001: 正常認証フロー
**目的**: 有効な設定での認証成功確認
**事前条件**: 有効なOAuth設定が設定済み
**テストデータ**: 
```rust
let config = OAuthConfig {
    client_id: "valid_client_id".to_string(),
    client_secret: "valid_client_secret".to_string(),
    redirect_uri: "http://localhost:8080/callback".to_string(),
    scopes: vec!["recording:read".to_string()],
};
```
**実行手順**:
1. OAuth設定でOAuthManagerを初期化
2. authenticate()を呼び出し
3. 認証フロー完了まで待機
**期待結果**:
- 認証成功でAccessTokenが返される
- トークンに有効期限が設定されている
- 認証状態がAuthenticatedに更新される

##### TC-AUTH-002: 無効設定での認証失敗
**目的**: 無効設定での適切なエラー処理確認
**事前条件**: 無効なOAuth設定
**テストデータ**:
```rust
let config = OAuthConfig {
    client_id: "invalid_client_id".to_string(),
    client_secret: "invalid_secret".to_string(),
    redirect_uri: "invalid_uri".to_string(),
    scopes: vec!["invalid_scope".to_string()],
};
```
**実行手順**:
1. 無効設定でOAuthManagerを初期化
2. authenticate()を呼び出し
**期待結果**:
- AuthError::ConfigurationErrorが返される
- 認証状態がAuthenticationFailedに更新される
- 適切なエラーメッセージが設定される

##### TC-AUTH-003: ネットワークエラー処理
**目的**: ネットワーク障害時の自動リトライ確認
**事前条件**: ネットワーク接続が不安定
**実行手順**:
1. ネットワークエラーを模擬
2. authenticate()を呼び出し
3. リトライ動作を確認
**期待結果**:
- 最大3回のリトライが実行される
- 最終的にAuthError::NetworkErrorが返される
- リトライ間隔が適切（1秒、2秒、4秒）

#### 1.2 refresh_token() テスト

##### TC-AUTH-004: トークン更新成功
**目的**: 有効なリフレッシュトークンでの更新確認
**事前条件**: 有効なリフレッシュトークンが存在
**実行手順**:
1. 有効なリフレッシュトークンを設定
2. refresh_token()を呼び出し
**期待結果**:
- 新しいAccessTokenが返される
- 新トークンの有効期限が未来日時
- 認証状態が更新される

##### TC-AUTH-005: 無効リフレッシュトークン
**目的**: 無効トークンでの適切なエラー処理
**実行手順**:
1. 無効なリフレッシュトークンを設定
2. refresh_token()を呼び出し
**期待結果**:
- AuthError::InvalidTokenが返される
- 再認証が要求される

### 2. Token Store テスト

#### 2.1 store_token() テスト

##### TC-STORE-001: トークン保存成功
**目的**: トークンの暗号化保存確認
**事前条件**: 書き込み可能なストレージパス
**テストデータ**:
```rust
let token = AccessToken {
    access_token: "sample_access_token".to_string(),
    refresh_token: Some("sample_refresh_token".to_string()),
    expires_at: Utc::now() + Duration::hours(1),
    token_type: "Bearer".to_string(),
};
```
**実行手順**:
1. AccessTokenオブジェクト作成
2. store_token()を呼び出し
3. ファイル存在確認
**期待結果**:
- ファイルが作成される
- 内容が暗号化されている（平文でない）
- ファイルサイズが適切

##### TC-STORE-002: ストレージ権限エラー
**目的**: 書き込み権限なし時のエラー処理
**事前条件**: 書き込み権限のないディレクトリ
**実行手順**:
1. 権限なしパスでTokenStoreを初期化
2. store_token()を呼び出し
**期待結果**:
- StorageError::PermissionDeniedが返される
- ファイルは作成されない

#### 2.2 retrieve_token() テスト

##### TC-STORE-003: トークン取得成功
**目的**: 暗号化トークンの復号化・取得確認
**事前条件**: 有効な暗号化トークンファイルが存在
**実行手順**:
1. 事前にトークンを保存
2. retrieve_token()を呼び出し
**期待結果**:
- 保存したトークンと同じ内容が返される
- 暗号化・復号化が正常動作
- None以外のOptionが返される

##### TC-STORE-004: ファイル不存在
**目的**: トークンファイル不存在時の処理
**事前条件**: トークンファイルが存在しない
**実行手順**:
1. 空のディレクトリでretrieve_token()を呼び出し
**期待結果**:
- Ok(None)が返される
- エラーは発生しない

##### TC-STORE-005: 破損ファイル処理
**目的**: 破損したトークンファイルでのエラー処理
**事前条件**: 破損したトークンファイル
**実行手順**:
1. 意図的に破損したファイルを配置
2. retrieve_token()を呼び出し
**期待結果**:
- StorageError::CorruptedDataが返される
- 適切なエラーメッセージ

### 3. Security Handler テスト

#### 3.1 encrypt() / decrypt() テスト

##### TC-SEC-001: 暗号化・復号化ラウンドトリップ
**目的**: 暗号化・復号化の可逆性確認
**テストデータ**:
```rust
let test_data = vec![
    b"short text".to_vec(),
    b"medium length text with special characters: !@#$%^&*()".to_vec(),
    vec![0u8; 1024], // 長いデータ
    vec![255u8; 512], // 全ビット1のデータ
];
```
**実行手順**:
1. 各テストデータを暗号化
2. 暗号化結果を復号化
3. 元データと比較
**期待結果**:
- 全データで元データと復号化データが一致
- 暗号化データが元データと異なる
- 処理時間が50ms以内

##### TC-SEC-002: 暗号化強度確認
**目的**: AES-256-GCM暗号化の確認
**実行手順**:
1. 同じデータを複数回暗号化
2. 暗号化結果の比較
**期待結果**:
- 毎回異なる暗号化結果（IVが異なる）
- 暗号化データから元データが推測不可能
- 適切な暗号化ヘッダが含まれる

##### TC-SEC-003: 無効データの復号化
**目的**: 破損・改ざんデータでのエラー処理
**実行手順**:
1. 有効な暗号化データを生成
2. データを意図的に改ざん
3. 復号化を試行
**期待結果**:
- SecurityError::DecryptionFailedが返される
- 部分的なデータ漏洩なし

#### 3.2 キー管理テスト

##### TC-SEC-004: 暗号化キー生成
**目的**: セキュアなキー生成確認
**実行手順**:
1. 複数回キー生成
2. キーの品質確認
**期待結果**:
- 毎回異なるキーが生成される
- キー長が256ビット
- 暗号学的に安全なランダム性

##### TC-SEC-005: キー保存・読み込み
**目的**: キーの永続化・復元確認
**実行手順**:
1. キーを生成・保存
2. 保存されたキーを読み込み
3. 暗号化・復号化テスト
**期待結果**:
- キーが正確に保存・復元される
- 復元キーで暗号化・復号化が正常動作

### 4. Auth State Manager テスト

#### 4.1 状態遷移テスト

##### TC-STATE-001: 正常状態遷移
**目的**: 認証状態の正常遷移確認
**実行手順**:
1. NotAuthenticated状態で開始
2. 認証開始でAuthenticating状態に遷移
3. 認証成功でAuthenticated状態に遷移
**期待結果**:
- 状態遷移が正確に実行される
- 各状態で適切な情報が設定される
- 状態変更通知が送信される

##### TC-STATE-002: エラー状態遷移
**目的**: エラー発生時の状態遷移確認
**実行手順**:
1. 認証処理中にエラー発生
2. AuthenticationFailed状態に遷移
**期待結果**:
- エラー情報が適切に設定される
- 回復可能なエラーで適切な状態設定

#### 4.2 状態通知テスト

##### TC-STATE-003: オブザーバー通知
**目的**: 状態変更通知の動作確認
**実行手順**:
1. モックオブザーバーを登録
2. 状態変更を実行
3. 通知受信確認
**期待結果**:
- 全登録オブザーバーに通知送信
- 通知内容が正確
- 通知順序が保証される

### 5. Auth Validator テスト

#### 5.1 トークン検証テスト

##### TC-VALID-001: 有効トークン検証
**目的**: 有効トークンの正確な検証
**実行手順**:
1. 有効なトークンで検証実行
**期待結果**:
- trueが返される
- 検証時間が100ms以内

##### TC-VALID-002: 無効トークン検証
**目的**: 無効トークンの検出確認
**実行手順**:
1. 無効なトークンで検証実行
**期待結果**:
- falseが返される
- 適切なエラーログ出力

##### TC-VALID-003: 期限切れトークン
**目的**: 期限切れトークンの検出
**実行手順**:
1. 期限切れトークンで検証実行
**期待結果**:
- is_token_expired()がtrueを返す
- needs_refresh()がtrueを返す

## Property-Based テスト仕様

### PBT-AUTH-001: 暗号化可逆性
**プロパティ**: ∀ data, encrypt(decrypt(encrypt(data))) = encrypt(data)
**生成器**: 任意のバイト配列（0-10KB）
**実行回数**: 1000回
**期待結果**: 全てのケースでプロパティが成立

### PBT-AUTH-002: 状態遷移一貫性
**プロパティ**: 有効な状態遷移のみが発生する
**生成器**: 状態遷移イベントの任意シーケンス
**実行回数**: 500回
**期待結果**: 無効な状態遷移が発生しない

### PBT-AUTH-003: トークン検証一貫性
**プロパティ**: 同じトークンの検証結果は常に同じ
**生成器**: 任意のトークン文字列
**実行回数**: 1000回
**期待結果**: 同一トークンで常に同じ検証結果

## テスト実行環境

### 必要環境
- **Rust**: 1.70以上
- **テストフレームワーク**: cargo test + proptest
- **モック**: mockall crate
- **カバレッジ**: tarpaulin

### テスト実行コマンド
```bash
# 単体テスト実行
cargo test --lib auth_component

# Property-basedテスト実行
PROPTEST_CASES=1000 cargo test property_tests

# カバレッジ測定
cargo tarpaulin --out html --output-dir coverage/
```

### テスト品質基準
- **全テスト成功**: 100%
- **実行時間**: < 30秒
- **メモリ使用量**: < 100MB
- **カバレッジ**: コード > 90%, ブランチ > 85%

---

**承認**:  
認証開発者: [ ] 承認  
品質保証エンジニア: [ ] 承認  
**承認日**: ___________