@startuml ProductionDeploymentDiagram
!theme plain
title 詳細配置図 - 実運用環境・ライブラリ依存関係

node "Windows 10/11 Environment" as Windows {
  
  node "User Application Space" as UserSpace {
    artifact "zoom_video_mover.exe" as MainApp {
      component "egui GUI" as GUI
      component "tokio Runtime" as Runtime
      component "Business Logic" as Logic
      component "HTTP Client Pool" as HttpPool
    }
    
    database "Application Data" as AppData {
      file "config.toml" as Config
      file "auth_tokens.enc" as Tokens
      file "download_history.json" as History
      file "application.log" as Logs
    }
    
    folder "Download Storage" as Downloads {
      folder "2025-08-03" as DateFolder {
        file "meeting_123_video.mp4" as Video
        file "meeting_123_audio.mp3" as Audio
        file "meeting_123_transcript.vtt" as Transcript
        file "meeting_123_chat.txt" as Chat
        file "meeting_123_summary.json" as Summary
      }
    }
  }
  
  node "System Libraries" as SystemLibs {
    artifact "MSVCRT.dll" as MSVCRT
    artifact "WS2_32.dll" as Winsock
    artifact "CRYPT32.dll" as CryptAPI
    artifact "SHELL32.dll" as ShellAPI
    artifact "USER32.dll" as UserAPI
  }
  
  node "Rust Runtime Dependencies" as RustDeps {
    artifact "reqwest.dll" as Reqwest {
      dependency "hyper" as Hyper
      dependency "rustls" as RustTLS
      dependency "tokio" as Tokio
    }
    
    artifact "egui_dependencies" as EguiDeps {
      dependency "wgpu" as WGPU
      dependency "winit" as Winit
    }
    
    artifact "crypto_dependencies" as CryptoDeps {
      dependency "aes-gcm" as AesGcm
      dependency "ring" as Ring
    }
  }
}

cloud "Internet Infrastructure" as Internet {
  node "CDN/Load Balancer" as CDN
  
  node "Zoom Production Infrastructure" as ZoomProd {
    component "OAuth Authorization Server" as AuthServer {
      interface "HTTPS :443" as OAuthHTTPS
      database "OAuth State Store" as OAuthDB
    }
    
    component "API Gateway" as APIGateway {
      interface "HTTPS :443" as APIHTTP
      component "Rate Limiter" as RateLimit
      component "Authentication" as APIAuth
    }
    
    component "Recording Service Cluster" as RecordingCluster {
      database "Recording Metadata DB" as MetadataDB
      database "AI Summary Store" as AISummaryDB
    }
    
    component "CDN Storage" as RecordingCDN {
      database "Video Files" as VideoStorage
      database "Audio Files" as AudioStorage
      database "Transcript Files" as TranscriptStorage
    }
  }
}

node "Microsoft Infrastructure" as MSInfra {
  component "Windows Defender" as Defender {
    interface "Real-time Protection" as RTProtection
  }
  
  component "Windows Update" as WinUpdate {
    interface "Update Service" as UpdateSvc
  }
  
  component "Certificate Store" as CertStore {
    database "Trusted Root CAs" as RootCAs
    database "Intermediate CAs" as IntermediateCAs
  }
}

' ネットワーク通信
MainApp --> Internet : "HTTPS requests"
Internet --> CDN : "SSL termination"
CDN --> APIGateway : "Backend routing"
CDN --> RecordingCDN : "File downloads"

' 認証フロー
MainApp --> AuthServer : "OAuth 2.0 flow"
AuthServer --> APIGateway : "Token validation"
APIGateway --> RecordingCluster : "Authorized requests"

' システム依存関係
MainApp --> SystemLibs : "Win32 API calls"
MainApp --> RustDeps : "Runtime dependencies"
RustDeps --> SystemLibs : "System integration"

' セキュリティ統合
MainApp --> CertStore : "Certificate validation"
MainApp --> Defender : "Malware scanning"
AppData --> Defender : "File scanning"
Downloads --> Defender : "Real-time protection"

' データフロー
MainApp --> AppData : "Configuration & logs"
MainApp --> Downloads : "Downloaded content"

' 品質属性・制約
note right of MainApp
  **Runtime Requirements:**
  - Memory: Max 1GB heap
  - CPU: < 10% sustained
  - Network: HTTPS only (TLS 1.3)
  - Files: Atomic operations
end note

note left of ZoomProd
  **API Constraints:**
  - Rate Limit: 10 req/sec/user
  - OAuth: PKCE required
  - Token Expiry: 1 hour
  - Max file size: 4GB
end note

note bottom of SystemLibs
  **Windows Dependencies:**
  - Minimum: Windows 10 build 1903
  - .NET Framework: Not required
  - Visual C++ Redistributable: Embedded
  - Windows Defender: Compatibility tested
end note

' セキュリティ境界
rectangle "Encrypted Storage Boundary" {
  Tokens
  note bottom : AES-256-GCM encrypted
}

rectangle "Network Security Boundary" {
  Internet
  note top : TLS 1.3, Certificate Pinning
}

rectangle "Process Isolation Boundary" {
  UserSpace
  note right : Process-level isolation
}

@enduml