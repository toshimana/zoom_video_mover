@startuml DownloadTaskStateDiagram
!theme plain
title 状態遷移図 - DownloadTask状態管理

[*] --> PENDING : タスク作成

state PENDING {
  PENDING : entry / validateTarget()
  PENDING : exit / prepareDownload()
}

PENDING --> IN_PROGRESS : start() / beginDownload()
PENDING --> CANCELLED : cancel() / cleanup()

state IN_PROGRESS {
  IN_PROGRESS : entry / openStream()
  IN_PROGRESS : do / downloadChunks()
  IN_PROGRESS : do / updateProgress()
  IN_PROGRESS : exit / closeStream()
  
  state DOWNLOADING {
    DOWNLOADING : do / receiveData()
    DOWNLOADING : do / writeToFile()
    DOWNLOADING : do / updateBytes()
  }
  
  state VERIFYING {
    VERIFYING : entry / calculateChecksum()
    VERIFYING : do / compareHashes()
  }
  
  DOWNLOADING --> VERIFYING : downloadComplete()
}

IN_PROGRESS --> PAUSED : pause() / suspendDownload()
IN_PROGRESS --> CANCELLED : cancel() / abortDownload()
IN_PROGRESS --> FAILED : error() / logError()
IN_PROGRESS --> COMPLETED : verificationSuccess() / finalizeFile()

state PAUSED {
  PAUSED : entry / saveState()
  PAUSED : do / maintainPartialFile()
}

PAUSED --> IN_PROGRESS : resume() / restoreState()
PAUSED --> CANCELLED : cancel() / cleanupPartial()
PAUSED --> FAILED : timeout() / expireTask()

state FAILED {
  FAILED : entry / logError()
  FAILED : do / prepareRetry()
}

FAILED --> PENDING : retry() [retryCount < maxRetries] / incrementRetry()
FAILED --> CANCELLED : retry() [retryCount >= maxRetries] / giveUp()
FAILED --> CANCELLED : cancel() / cleanup()

state COMPLETED {
  COMPLETED : entry / notifyCompletion()
  COMPLETED : do / updateHistory()
}

state CANCELLED {
  CANCELLED : entry / cleanup()
  CANCELLED : do / removePartialFiles()
}

COMPLETED --> [*] : cleanup()
CANCELLED --> [*] : cleanup()

' イベント定義
note right of PENDING
  **Events:**
  - start(): ダウンロード開始
  - cancel(): キャンセル
  
  **Guards:**
  - targetPathValid
  - networkAvailable
  - spaceAvailable
end note

note right of IN_PROGRESS
  **Events:**
  - pause(): 一時停止
  - cancel(): キャンセル
  - error(): エラー発生
  - downloadComplete(): 完了
  
  **Actions:**
  - updateProgress()
  - notifyProgress()
  - writeChunk()
end note

note bottom of FAILED
  **Error Types:**
  - NetworkError: 通信エラー
  - FileSystemError: ファイル操作エラー
  - AuthenticationError: 認証エラー
  - ChecksumError: 整合性エラー
  
  **Retry Strategy:**
  - 指数バックオフ
  - 最大3回リトライ
  - エラー種別別戦略
end note

@enduml