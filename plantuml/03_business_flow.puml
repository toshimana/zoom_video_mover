@startuml ビジネスフロー図
!theme plain

skinparam backgroundColor #FAFAFA
skinparam activityBackgroundColor #E8F4FD
skinparam activityBorderColor #333333
skinparam activityStartColor #90EE90
skinparam activityEndColor #FFB6C1
skinparam activityDiamondBackgroundColor #FFFFE0

title ビジネスフロー図 - 録画ダウンロードプロセス

start

:初期設定;
note right
  - OAuth設定確認
  - config.toml読込
  - 認証情報検証
end note

if (認証情報が有効?) then (Yes)
  :既存認証使用;
else (No)
  :Zoom認証実行;
  note right
    - OAuth 2.0フロー
    - ブラウザ起動
    - 認証コード取得
    - アクセストークン取得
  end note
  
  if (認証成功?) then (No)
    :エラー表示;
    note right
      - エラーメッセージ表示
      - ログ出力
      - 再試行オプション提示
    end note
    stop
  else (Yes)
    :認証情報保存;
  endif
endif

:録画一覧取得;
note right
  - Zoom API呼出し
  - 録画リスト取得
  - メタデータ解析
end note

if (録画が存在?) then (No)
  :「録画なし」表示;
  stop
else (Yes)
  :録画一覧表示;
endif

:ファイル選択;
note right
  - チェックボックス選択
  - 動画・音声・チャット
  - AI要約・トランスクリプト
  - 保存先フォルダ指定
end note

if (選択済み?) then (No)
  :選択促進メッセージ;
  backward :録画一覧表示;
else (Yes)
  :ダウンロード開始;
endif

fork
  :動画ファイルDL;
fork again
  :音声ファイルDL;
fork again
  :チャットログDL;
fork again
  :AI要約DL;
end fork

:進捗表示更新;
note right
  - プログレスバー
  - 完了ファイル数
  - 残り時間表示
  - エラー状況
end note

if (全ファイル完了?) then (No)
  if (エラー発生?) then (Yes)
    :リトライ処理;
    note right
      - 指数バックオフ
      - 最大3回リトライ
      - ネットワークエラー対応
    end note
    
    if (リトライ成功?) then (No)
      :エラーログ出力;
      :部分完了として処理;
    else (Yes)
      backward :進捗表示更新;
    endif
  else (No)
    backward :進捗表示更新;
  endif
else (Yes)
  :完了通知;
endif

:結果レポート表示;
note right
  - 成功ファイル数
  - 失敗ファイル数
  - 保存先パス
  - 所要時間
end note

:ログファイル出力;
note right
  - 処理詳細ログ
  - エラー詳細
  - パフォーマンス情報
end note

stop

@enduml